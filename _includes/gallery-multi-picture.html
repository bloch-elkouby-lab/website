{% assign carousel_id = 'carousel-' | append: include.title | slugify %}

<div class="gallery-picture" data-style="{{ include.style }}" style="width: 100%; max-width: 800px; display: block; margin: 0 auto;">

  <div class="feature-image" id="{{ carousel_id }}" style="position: relative; overflow: hidden; line-height: 0;">
    {% assign image_list = include.images | split: "," %}
    {% for img in image_list %}
      <img
        class="carousel-slide-{{ carousel_id }}"
        src="{{ img | strip | relative_url }}"
        loading="lazy"
        alt="Gallery image {{ forloop.index }}"
        style="width: 100%; display: none; object-fit: cover;"
        {% if include.fit %}class="img-fit"{% endif %}
        {% include fallback.html %}
      >
    {% endfor %}

    {% if image_list.size > 1 %}
      <button class="carousel-button prev" onclick="plusSlides('{{ carousel_id }}', -1)" aria-label="Previous">&#10094;</button>
      <button class="carousel-button next" onclick="plusSlides('{{ carousel_id }}', 1)" aria-label="Next">&#10095;</button>
    {% endif %}
  </div>

  <div class="gallery-caption" style="text-align: center; width: 100%; margin-top: 10px; display: block;">
    {% if include.caption %}
        {{ include.caption | markdownify }}
    {% elsif include.title %}
        <p style="margin: 0; font-weight: bold;">{{ include.title }}</p>
    {% endif %}
  </div>
</div>

<style>
/* Scoped styles to match your existing gallery buttons */
#{{ carousel_id }} .carousel-button {
  position: absolute;
  top: 50%;
  background-color: rgba(0,0,0,0.3);
  color: white;
  border: none;
  padding: 8px 10px;
  font-size: 16px;
  cursor: pointer;
  transform: translateY(-50%);
  z-index: 2;
  transition: opacity 0.2s;
}
#{{ carousel_id }} .carousel-button:hover {
  background-color: rgba(0,0,0,0.6);
}
.carousel-button.prev { left: 0; border-radius: 0 4px 4px 0; }
.carousel-button.next { right: 0; border-radius: 4px 0 0 4px; }
</style>

<script>
window.carouselState = window.carouselState || {};

function showSlides(id, n) {
  const container = document.getElementById(id);
  if (!container) return;
  const slides = container.querySelectorAll(".carousel-slide-" + id);
  if (!slides.length) return;
  if (!(id in window.carouselState)) window.carouselState[id] = 0;
  const total = slides.length;
  const index = (n + total) % total;
  slides.forEach((slide, i) => {
    slide.style.display = (i === index) ? "block" : "none";
  });
  window.carouselState[id] = index;
}

function plusSlides(id, delta) {
  showSlides(id, (window.carouselState[id] ?? 0) + delta);
}

// Ensure first slide shows immediately
(function() {
  const init = () => {
    const el = document.getElementById('{{ carousel_id }}');
    if (el) showSlides('{{ carousel_id }}', 0);
  };
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>