{% assign carousel_id = 'carousel-' | append: include.title | slugify %}

<div class="gallery-column-item" style="flex: 1; min-width: 350px; max-width: 800px; margin: 20px;">
  <div class="gallery-picture" style="width: 100%; text-align: center;">
    
    <div id="{{ carousel_id }}" style="position: relative; overflow: hidden; border-radius: 8px; background: #f0f0f0; line-height: 0;">
      {% assign image_list = include.images | split: "," %}
      {% for img in image_list %}
        <img
          class="carousel-slide-{{ carousel_id }}"
          src="{{ img | strip | relative_url }}"
          loading="lazy"
          style="width: 100%; height: auto; aspect-ratio: 16/9; object-fit: cover; display: none;"
        >
      {% endfor %}

      {% if image_list.size > 1 %}
        <button type="button" class="carousel-btn prev" onclick="plusSlides('{{ carousel_id }}', -1)">&#10094;</button>
        <button type="button" class="carousel-btn next" onclick="plusSlides('{{ carousel_id }}', 1)">&#10095;</button>
      {% endif %}
    </div>

    <div class="gallery-caption" style="text-align: center; margin-top: 15px;">
        <p style="margin: 0; font-weight: bold; font-size: 1.2em;">{{ include.title }}</p>
        {% if include.text %}
          <div style="font-size: 0.95em; color: #555; margin-top: 5px;">{{ include.text | markdownify }}</div>
        {% endif %}
    </div>
  </div>
</div>

<style>
/* Scoped styles to prevent collisions */
#{{ carousel_id }} .carousel-btn {
  position: absolute; top: 50%; transform: translateY(-50%);
  background: rgba(0,0,0,0.5); color: white; border: none;
  padding: 15px 10px; cursor: pointer; z-index: 10;
}
.prev { left: 0; border-radius: 0 4px 4px 0; }
.next { right: 0; border-radius: 4px 0 0 4px; }
</style>

<script>
// Prevent re-declaration errors if the include is used twice
if (typeof window.carouselState === 'undefined') {
    window.carouselState = {};
}

function showSlides(id, n) {
    var container = document.getElementById(id);
    if (!container) return;
    var slides = container.querySelectorAll(".carousel-slide-" + id);
    if (slides.length === 0) return;

    if (!(id in window.carouselState)) window.carouselState[id] = 0;
    var total = slides.length;
    var index = (n + total) % total;

    for (var i = 0; i < slides.length; i++) {
        slides[i].style.display = (i === index) ? "block" : "none";
    }
    window.carouselState[id] = index;
}

function plusSlides(id, delta) {
    showSlides(id, (window.carouselState[id] || 0) + delta);
}

// Safer initialization for GitHub Dev environments
(function() {
    var initCarousel = function() {
        var el = document.getElementById('{{ carousel_id }}');
        if (el) showSlides('{{ carousel_id }}', 0);
    };
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCarousel);
    } else {
        initCarousel();
    }
})();
</script>