{% assign carousel_id = 'carousel-' | append: include.title | slugify %}

<div class="gallery-picture-wrapper" data-style="{{ include.style }}">
  {% if include.title %}
    <p class="feature-title
      {% if include.align %}
        {{ include.align }}
      {% endif %}
    ">{{ include.title }}</p>
  {% endif %}

  <div class="feature" {% if include.flip %} data-flip {% endif %}>
    <div class="feature-image" id="{{ carousel_id }}" style="position: relative; overflow: hidden; border-radius: 6px;">
      {% assign image_list = include.images | split: "," %}
      {% for img in image_list %}
        <img
          class="carousel-slide-{{ carousel_id }}"
          {% if include.fit %} img-fit {% endif %}
          src="{{ img | strip | relative_url }}"
          loading="lazy"
          alt="Gallery image {{ forloop.index }}"
          style="width: 100%; display: none; border-radius: 6px; object-fit: cover;"
          {% include fallback.html %}
        >
      {% endfor %}

      {% if image_list.size > 1 %}
        <button class="carousel-button prev" onclick="plusSlides('{{ carousel_id }}', -1)">&#10094;</button>
        <button class="carousel-button next" onclick="plusSlides('{{ carousel_id }}', 1)">&#10095;</button>
      {% endif %}
    </div>

    <div class="feature-text">
      {{ include.text | markdownify }}
      
      {% if include.caption %}
        <div class="gallery-caption" style="font-style: italic; font-size: 0.9em; margin-top: 10px;">
          {{ include.caption }}
        </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
.carousel-button {
  position: absolute;
  top: 50%;
  background-color: rgba(0,0,0,0.4);
  color: white;
  border: none;
  padding: 10px 14px;
  font-size: 18px;
  cursor: pointer;
  transform: translateY(-50%);
  border-radius: 4px;
  z-index: 2;
  transition: background 0.2s;
}
.carousel-button:hover {
  background-color: rgba(0,0,0,0.7);
}
.carousel-button.prev { left: 10px; }
.carousel-button.next { right: 10px; }
</style>

<script>
window.carouselState = window.carouselState || {};

function showSlides(id, n) {
  const container = document.getElementById(id);
  if (!container) return;

  // Find slides specifically for this carousel instance
  const slides = container.querySelectorAll(".carousel-slide-" + id);
  if (!slides.length) return;

  if (!(id in window.carouselState)) window.carouselState[id] = 0;

  const total = slides.length;
  const index = (n + total) % total;

  slides.forEach((slide, i) => {
    slide.style.display = (i === index) ? "block" : "none";
  });

  window.carouselState[id] = index;
}

function plusSlides(id, delta) {
  const current = window.carouselState[id] ?? 0;
  showSlides(id, current + delta);
}

document.addEventListener("DOMContentLoaded", function() {
  const allCarousels = document.querySelectorAll("[id^='carousel-']");
  allCarousels.forEach(el => showSlides(el.id, 0));
});
</script>